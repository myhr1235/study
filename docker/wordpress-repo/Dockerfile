FROM wordpress:6.5-php8.2-apache

# ğŸ”„ ê¸°ì¡´ê³¼ ë™ì¼: Apache ê²½ê³  ì œê±° + rewrite ëª¨ë“ˆ
RUN printf "ServerName localhost\n" > /etc/apache2/conf-available/servername.conf \
 && a2enconf servername && a2enmod rewrite \
 && a2enmod headers  # âœ… ECSìš© ì¶”ê°€: HTTP í—¤ë” ëª¨ë“ˆ (ë³´ì•ˆ, ìºì‹±ìš©)

# âœ… ECSìš© ì¶”ê°€: PHP ì„±ëŠ¥ ìµœì í™” (Fargate í™˜ê²½ì—ì„œ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± ê°œì„ )
RUN docker-php-ext-install opcache

# âœ… ECSìš© ì¶”ê°€: OPcache ì„¤ì • (ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì‹œì—ë„ ì„±ëŠ¥ ìœ ì§€)
RUN { \
    echo 'opcache.memory_consumption=128'; \
    echo 'opcache.interned_strings_buffer=8'; \
    echo 'opcache.max_accelerated_files=4000'; \
    echo 'opcache.revalidate_freq=2'; \
    echo 'opcache.fast_shutdown=1'; \
    } > /usr/local/etc/php/conf.d/opcache-recommended.ini

# âœ… ECSìš© ì¶”ê°€: Apache ì••ì¶•/ìºì‹± ëª¨ë“ˆ (ë¡œë“œë°¸ëŸ°ì„œì™€ í•¨ê»˜ ì‚¬ìš©)
RUN { \
    echo 'LoadModule deflate_module modules/mod_deflate.so'; \
    echo 'LoadModule expires_module modules/mod_expires.so'; \
    } >> /etc/apache2/apache2.conf

# ğŸ”„ ê¸°ì¡´ê³¼ ë™ì¼: ì»¤ìŠ¤í…€ wp-config.php ë³µì‚¬
COPY wp-config.php /usr/src/wordpress/wp-config.php

# ğŸ”„ ê¸°ì¡´ê³¼ ë™ì¼: ì»¤ìŠ¤í…€ ì»¨í…ì¸  ë³µì‚¬ (í…Œë§ˆ, í”ŒëŸ¬ê·¸ì¸ ë“±)
COPY wp-content/ /usr/src/wordpress/wp-content/

# ğŸ”„ ê¸°ì¡´ê³¼ ë™ì¼: í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ (í•˜ì§€ë§Œ ECSì—ì„œ ì‹¤ì œë¡œ ì‚¬ìš©ë¨)
RUN printf "<?php http_response_code(200); echo 'ok';" > /usr/src/wordpress/healthz.php

# ğŸ”„ ê¸°ì¡´ê³¼ ë™ì¼: ê¶Œí•œ ì„¤ì •
RUN chown -R www-data:www-data /usr/src/wordpress

# âœ… ECSìš© ì¶”ê°€: ëª…ì‹œì  í¬íŠ¸ ë…¸ì¶œ (ECS íƒœìŠ¤í¬ ì •ì˜ì—ì„œ í•„ìš”)
EXPOSE 80

# âœ… ECSìš© ì¶”ê°€: Docker í—¬ìŠ¤ì²´í¬ ì„¤ì • (ECS í—¬ìŠ¤ì²´í¬ì™€ ì—°ë™)
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost/healthz.php || exit 1
