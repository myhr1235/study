name: Deploy WordPress  # GitHub Actions 워크플로우 이름 (Actions 탭에 표시됨)

on:
  push:
    branches: [ main ]  # main 브랜치에 push 이벤트가 발생하면 워크플로우 실행

jobs:
  deploy:  # Job 이름
    runs-on: ubuntu-latest  # GitHub에서 제공하는 Ubuntu 최신 가상환경에서 실행

    steps:
    - name: Checkout Repo  # GitHub 레포지토리를 현재 가상 환경으로 가져오기
      uses: actions/checkout@v3  # 공식 액션 사용 (필수)

    - name: Set up SSH  # SSH 접속을 위한 에이전트 설정
      uses: webfactory/ssh-agent@v0.7.0  # SSH Agent를 설정하여 private key를 로드
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}  # GitHub Secrets에 저장된 EC2용 개인키 (.pem 내용)

    - name: Deploy to EC2  # 실제 배포 작업 수행 (EC2 접속 및 명령 실행)
      run: |
        ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} << 'EOF'  # EC2에 SSH로 접속
        cd /home/ec2-user/wordpress  # 워드프레스 프로젝트 디렉토리로 이동
        git pull origin main         # GitHub에서 최신 코드 가져오기
        docker-compose down          # 기존 컨테이너 중단 및 정리
        docker-compose up -d --build # 컨테이너 재생성 및 백그라운드 실행 (빌드 포함)
        EOF
